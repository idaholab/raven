<?xml version="1.0"?>
<Simulation>

  <TestInfo>
    <name>framework/ROM/TimeSeries/DMD.ParametrizedDMDC</name>
    <author>alfoa</author>
    <created>2020-12-10</created>
    <classesTested>ROM.SupervisedLearning.DynamicModeDecompositionControl</classesTested>
    <description>
       This test is aimed to check the mechanics of the DMDC ROM using the standard SVD-based
       algorithm. The shows how to construct a parametrized DMDC model. The parameters here are represented
       by 2 ``uncertanties'', namely ``mod'' and ``flow''. The model is then evaluated in a simple
       MonteCarlo sampling.
       In addition, this input tests the capability for the user to export the ROM info in an XML output
       file (requirement).
    </description>
    <revisions>
      <revision author="alfoa" date="2020-12-10">Definition of the final test</revision>
    </revisions>
  </TestInfo>

  <RunInfo>
    <WorkingDir>DMDC/ParametrizedDMDC</WorkingDir>
    <Sequence>readTrainData,DMDCTrain,pickleRom,stats,writeOut,runDMDc</Sequence>
    <batchSize>1</batchSize>
  </RunInfo>

  <Files>
    <!--  we load a synthesized data with 1 time, 1 actuation(u), 3 state(x) and 2 output(y) -->
	<!-- Note: Adjacent rows should have constant time interval for DMDC -->
    <Input name="TrainDataFile">../trainingData/SES_22_TUYX_Selected_hs2.csv</Input>
    <Input name="ROMpk" type="">ROMpk</Input>
  </Files>
  
  <Models>
    <ROM name="DMDrom" subType="DMDC">
      <!-- Target contains y(s) beside Time => Calculate A, B and C -->
      <Target>Time,x1,x2,x3,y1,y2</Target>
      <!-- Features include all the u(t), x(t), p(s) -->
      <Features>u1,mod,flow,x1_init,x2_init,x3_init</Features>
      <!-- <Features>u1,mod,flow,x1_init,x2_init,x3_init</Features> -->
      <!-- Actuator variables u(t) are listed below -->
      <actuators>u1</actuators>
      <!-- StateVariables x(t) are listed below -->
      <stateVariables>x1,x2,x3</stateVariables>
      <!-- Initialization Variables-->
      <initStateVariables>x1_init,x2_init,x3_init</initStateVariables>
      <!-- Pivot variable (e.g. Time) -->
      <pivotParameter>Time</pivotParameter>
      <rankSVD>-1</rankSVD>
      <!-- rankSVD: -1 = No truncation; 0 = optimized truncation; pos. int = truncation level -->
      <subtractNormUXY>True</subtractNormUXY>
	  <!-- SubtractNormUXY: True = will subtract the initial values from U,X,Y -->
    </ROM>
  </Models>

  <Distributions>
    <Uniform name="mod">
      <lowerBound>0</lowerBound>
      <upperBound>1</upperBound>
    </Uniform>
    <Uniform name="flow">
      <lowerBound>20</lowerBound>
      <upperBound>100</upperBound>
    </Uniform>
  </Distributions>
  
  <Samplers>
    <MonteCarlo name="mcSampler">
      <samplerInit>
        <limit>2</limit>
        <initialSeed>20021986</initialSeed>
      </samplerInit>
      <variable name="mod">
        <distribution>mod</distribution>
      </variable>
      <variable name="flow">
        <distribution>flow</distribution>
      </variable>
       <constant name="x1_init">1160285.875</constant>
       <constant name="x2_init">0.524227738</constant>
       <constant name="x3_init">430.993988</constant>
       <constant name="u1" shape="721">
          1201221.875 1242158 1283094.125 1324030.25 1364966.375 1405902.5 1446838.5 1487774.625 1528710.75 1569646.875
          1610583 1651519.125 1692455.125 1733391.25 1774327.375 1815263.5 1856199.625 1897135.75 1938071.75 1979007.875
          2019944 2060880.125 2101816.25 2142752.25 2183688.5 2224624.5 2265560.75 2306496.75 2347432.75 2388369 2429305
          2470241.25 2511177.25 2552113.5 2593049.5 2633985.5 2674921.75 2715857.75 2756794 2797730 2838666 2879602.25
          2920538.25 2961474.5 3002410.5 3043346.75 3084282.75 3125218.75 3166155 3207091 3248027.25 3288963.25 3329899.25
          3370835.5 3411771.5 3452707.75 3493643.75 3534580 3575516 3616452 3657388.25 3698324.25 3739260.5 3780196.5 3821132.5
          3862068.75 3903004.75 3943941 3984877 4025813.25 4066749.25 4107685.25 4148621.5 4189557.5 4230493.5 4271430 4312366
          4353302 4394238 4435174 4476110.5 4517046.5 4557982.5 4598918.5 4639854.5 4680791 4721727 4762663 4803599 4844535
          4885471.5 4926407.5 4967343.5 5008279.5 5049216 5090152 5131088 5172024 5212960 5253896.5 5294832.5 5335768.5 5376704.5
          5417640.5 5458577 5499513 5540449 5581385 5622321 5663257.5 5704193.5 5745129.5 5786065.5 5827001.5 5867938 5908874
          5949810 5990746 6031682.5 6072618.5 6113554.5 6154490.5 6195426.5 6236363 6277299 6318235 6359171 6400107 6441043.5 6481979.5
          6522915.5 6563851.5 6604787.5 6645724 6686660 6727596 6768532 6809468 6850404.5 6891340.5 6932276.5 6973212.5 7014149 7055085
          7096021 7136957 7177893 7218829.5 7259765.5 7300701.5 7341637.5 7382573.5 7423510 7464446 7505382 7546318 7587254 7628190.5
          7669126.5 7710062.5 7750998.5 7791935 7832871 7873807 7914743 7955679 7996615.5 8037551.5 8078487.5 8119423.5 8160359.5 8201296
          8242232 8283168 8324104 8365040 8405976 8446912 8487849 8528785 8569721 8610657 8651593 8692529 8733465 8774401 8815337 8856273
          8897210 8938146 8979082 9020018 9060954 9101890 9142826 9183762 9224698 9265635 9306571 9347507 9388443 9429379 9470315 9511251
          9552187 9593123 9634059 9674996 9715932 9756868 9797804 9838740 9879676 9920612 9961548 10002484 10043421 10084357 10125293
          10166229 10207165 10248101 10289037 10329973 10370909 10411845 10452782 10493718 10534654 10575590 10616526 10657462 10698398
          10739334 10780270 10821206 10862143 10903079 10944015 10984951 11025887 11066823 11107759 11148695 11189631 11230568 11271504
          11312440 11353376 11394312 11435248 11476184 11517120 11558056 11598992 11639929 11680865 11721801 11762737 11803673 11844609
          11885545 11926481 11967417 12008354 12049290 12090226 12131162 12172098 12213034 12253970 12294906 12335842 12376778 12417715
          12458651 12499587 12540523 12581459 12622395 12663331 12704267 12745203 12786140 12827076 12868012 12908948 12949884 12990820
          13031756 13072692 13113628 13154564 13195501 13236437 13277373 13318309 13359245 13400181 13441117 13482053 13522989 13563925
          13604862 13645798 13686734 13727670 13768606 13809542 13850478 13891414 13932350 13973287 14014223 14055159 14096095 14137031
          14177967 14218903 14259839 14300775 14341711 14382648 14423584 14464520 14505456 14546392 14587328 14628264 14669200 14710136
          14751073 14792009 14832945 14873881 14914817 14955753 14996689 15037625 15078561 15119497 15160434 15201370 15242306 15283242
          15324178 15365114 15406050 15446986 15487922 15528859 15569795 15610731 15651667 15692603 15733539 15774475 15815411 15856347
          15847030 15837712 15828395 15819077 15809759 15800442 15791124 15781807 15772489 15763171 15753854 15744536 15735219 15725901
          15716584 15707266 15697948 15688631 15679313 15669996 15660678 15651360 15642043 15632725 15623408 15614090 15604773 15595455
          15586137 15576820 15567502 15558185 15548867 15539549 15530232 15520914 15511597 15502279 15492962 15483644 15474326 15465009
          15455691 15446374 15437056 15427738 15418421 15409103 15399786 15390468 15381150 15371833 15362515 15353198 15343880 15334563
          15325245 15315927 15306610 15297292 15287975 15278657 15269339 15260022 15250704 15241387 15232069 15222752 15213434 15204116
          15194799 15185481 15176164 15166846 15157528 15148211 15138893 15129576 15120258 15110941 15101623 15092305 15082988 15073670
          15064353 15055035 15045717 15036400 15027082 15017765 15008447 14999129 14989812 14980494 14971177 14961859 14952542 14943224
          14933906 14924589 14915271 14905954 14896636 14887318 14878001 14868683 14859366 14850048 14840731 14831413 14822095 14812778
          14803460 14794143 14784825 14775507 14766190 14756872 14747555 14738237 14728920 14719602 14710284 14700967 14691649 14682332
          14673014 14663696 14654379 14645061 14635744 14626426 14617108 14607791 14598473 14589156 14579838 14570521 14561203 14551885
          14542568 14533250 14523933 14514615 14505297 14495980 14486662 14477345 14468027 14458710 14449392 14440074 14430757 14421439
          14412122 14402804 14393486 14384169 14374851 14365534 14356216 14346899 14337581 14328263 14318946 14309628 14300311 14290993
          14281675 14272358 14263040 14253723 14244405 14235087 14225770 14216452 14207135 14197817 14188500 14179182 14169864 14160547
          14151229 14141912 14132594 14123276 14113959 14104641 14095324 14086006 14076689 14067371 14058053 14048736 14039418 14030101
          14020783 14011465 14002148 13992830 13983513 13974195 13964878 13955560 13946242 13936925 13927607 13918290 13908972 13899654
          13890337 13881019 13871702 13862384 13853066 13843749 13834431 13825114 13815796 13806479 13797161 13787843 13778526 13769208
          13759891 13750573 13741255 13731938 13722620 13713303 13703985 13694668 13685350 13676032 13666715 13657397 13648080 13638762
          13629444 13620127 13610809 13601492 13592174 13582857 13573539 13564221 13554904 13545586 13536269 13526951 13517633 13508316
          13498998 13489681 13480363 13471045 13461728 13452410 13443093 13433775 13424458 13415140 13405822 13396505 13387187 13377870
          13368552 13359234 13349917 13340599 13331282 13321964 13312647 13303329 13294011 13284694 13275376 13266059 13256741 13247423
          13238106 13228788 13219471 13210153 13200836 13191518 13182200 13172883 13163565 13154248 13144930 13135612 13126295 13116977
          13107660 13098342 13089024 13079707 13070389 13061072 13051754 13042437 13033119 13023801 13014484 13005166 12995849 12986531
          12977213 12967896 12958578 12949261 12939943 12930626 12921308 12911990 12902673 12893355 12884038 12874720 12865402 12856085
          12846767 12837450 12828132 12818814 12809497 12800179 12790862 12781544 12772227 12762909 12753591 12744274 12734956 12725639
          12716321 12707003 12697686 12688368 12679051 12669733 12660416 12651098 12641780 12632463 12623145 12613828 12604510 12595192
          12585875 12576557 12567240 12557922 12548605 12539287 12529969 12520652 12511334 12502017 12561016 12620015
       </constant>
   </MonteCarlo>
  </Samplers>
  
  <Steps>
    <IOStep name="readTrainData">
      <Input class="Files" type="">TrainDataFile</Input>
      <Output class="DataObjects" type="HistorySet">TrainData</Output>
    </IOStep>
	<RomTrainer name="DMDCTrain">
      <Input class="DataObjects" type="HistorySet">TrainData</Input>
      <Output class="Models" type="ROM">DMDrom</Output>
    </RomTrainer>
    <IOStep name="pickleRom">
      <Input class="Models" type="ROM">DMDrom</Input>
      <Output class="Files" type="">ROMpk</Output>
    </IOStep>
    <IOStep name="stats">
      <Input class="Models" type="ROM">DMDrom</Input>
      <Output class="DataObjects" type="DataSet">rom_stats</Output>
    </IOStep>
    <IOStep name="writeOut" pauseAtEnd="True">
      <Input class="DataObjects" type="DataSet">rom_stats</Input>
      <Output class="OutStreams" type="Print">DMDcCxCoeff </Output>
    </IOStep>
    <MultiRun name="runDMDc">
      <Input class="DataObjects" type="PointSet">dataIn</Input>
      <Model class="Models" type="ROM">DMDrom</Model>
      <Sampler class="Samplers" type="MonteCarlo">mcSampler</Sampler>
      <Output class="DataObjects" type="HistorySet">outputData</Output>
      <Output class="OutStreams" type="Print">outputData</Output>
    </MultiRun>
  </Steps>
  <OutStreams>
    <Print name="DMDcCxCoeff">
      <type>csv</type>
      <source>rom_stats</source>
    </Print>
    <Print name="outputData">
      <type>csv</type>
      <source>outputData</source>
    </Print>
  </OutStreams>

  <DataObjects>
    <PointSet name="dataIn"/>
    <HistorySet name="outputData">
      <Input>mod,flow,x1_init,x2_init,x3_init</Input>
      <Output>u1,y1,y2,x1,x2,x3,Time</Output>
      <options>
        <pivotParameter>Time</pivotParameter>
      </options>
    </HistorySet>
    <HistorySet name="TrainData">
      <Input>mod,flow,x1_init,x2_init,x3_init</Input>
      <Output>u1,y1,y2,x1,x2,x3,Time</Output>
      <options>
        <pivotParameter>Time</pivotParameter>
      </options>
    </HistorySet>
    <DataSet name="rom_stats"/>
  </DataObjects>

</Simulation>
