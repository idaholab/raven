<?xml version="1.0" ?>
<Simulation verbosity="debug">
  <TestInfo>
    <name>framework/CodeInterfaceTests/OpenFOAM.basic</name>
    <author>alfoa</author>
    <created>2025-05-10</created>
    <classesTested>Models.Code.OpenFOAM</classesTested>
    <description>
       An example of using the interface with OpenFOAM for sampling boundary conditions.
       The test case here used is from the OpenFOAM tutorial folder ``twoSimpleRotors''.
       In this test it is shown that in the RAVEN context with OpenFOAM, the input file
       is a different concept since several inputs can be provided
       and consequentially the user must provide the folder that contains the standard
       subfolders used by openFOAM (i.e. 0 (or 0.orig), constant, system). The provided folder
       here MUST contain the ``Allrun'' bash script used to pre-process and run the case, which
       is the INPUT FILE that will be provided to RAVEN.
       The \\xmlNode{executable} MUST be set to the ``Allrun'' script.
       The \\xmlNode{preexec} can be used to run a command or script to set up the enviroment
       for the correct execution of OpenFOAM (e.g. set up the bash, enviroment variables, etc.).
       In this test, we sample 2 variables: 1) pressure, the pressure field (See file ``p'' in ``0.orig''
       folder), 2) the heat capacity ``Cp'' (see file ``thermophysicalProperties'' in ``constant'' folder).
    </description>
 
  </TestInfo>
  <RunInfo>
    <JobName>openfoam_sampling_bc</JobName>
    <Sequence>sample</Sequence>
    <WorkingDir>basic</WorkingDir>
    <batchSize>1</batchSize>
  </RunInfo>

  <Files>
    <!--
      OpenFOAM input file is a different concept since several inputs can be provided
      and consequentially the user must indicate the folder that contains the standard
      subfolders used by openFOAM (i.e. 0 (or 0.orig), constant, system), in the 'subDirectory'
      attribute. The folder than MUST contain the "Allrun" bash script used to pre-process and run the case, and
      that, in RAVEN context, represents the Input File.
    -->
    <Input name="twoSimpleRotors_Allrun" type="openfoam" subDirectory="twoSimpleRotors">Allrun</Input>
  </Files>

  <Models>
    <Code name="openFoam_code" subType="OpenFOAM">
      
      <!--
           Pre-exec here is used to open the openfoam shell
           (with all the enviroment variable set)
      -->
      <preexec>openfoam</preexec>
      <!--
        The executable is ALWAYS the Allrun script that the user must provide
        (this is a typical workflow in OpenFOAM simulations)
      -->
      <executable>Allrun</executable>
      <!--
        List of directories that contains OpenFOAM input files for this case
      -->
      <directoriesPerturbableInputs>0.orig, constant, system</directoriesPerturbableInputs>
      
      <!-- in the following we collect
           some function processed variables (e.g. average(p), average(U) )
           and mesh variables (e.g. T_12, p_12, etc.)
           the the outputVariables node is not present, all the variables are collected
      -->
      <outputVariables>cumulativeContErr, average(p), average(U)|x, average(U)|y, average(U)|z,
                       T|12, cellTypes|12, U|12|x, U|12|y, U|12|z, p|12</outputVariables>
 
    </Code>
  </Models>

  <Distributions>
    <Uniform name="Cp">
      <lowerBound>1000</lowerBound>
      <upperBound>1010</upperBound>
    </Uniform>
    <Uniform name="pressure">
      <lowerBound>1e5</lowerBound>
      <upperBound>2e5</upperBound>
    </Uniform>
  </Distributions>

  <Samplers>
    <Grid name="grid">
      <variable name="MixCp">
        <distribution>Cp</distribution>
        <grid construction="equal" steps="1" type="CDF">0.1 0.9</grid>
      </variable>
      <variable name="pressure">
        <distribution>pressure</distribution>
        <grid construction="equal" steps="1" type="CDF">0.2 0.8</grid>
      </variable>
    </Grid>
  </Samplers>

  <Steps>
    <MultiRun name="sample" clearRunDir="False">
      <Input   class="Files" type="opefoam">twoSimpleRotors_Allrun</Input>
      <Model   class="Models" type="Code">openFoam_code</Model>
      <Sampler class="Samplers" type="Grid">grid</Sampler>
      <Output  class="DataObjects" type="HistorySet">samplesHS</Output>
      <Output  class="OutStreams" type="Print">samplesHS</Output>
    </MultiRun>
  </Steps>

  <DataObjects>
    <HistorySet name="samplesHS">
      <Input>MixCp,pressure</Input>
      <Output>cumulativeContErr, average(p),
              average(U)|x, average(U)|y, average(U)|z,
              T|12, cellTypes|12, U|12|x, U|12|y, U|12|z, p|12</Output>
      <options>
        <pivotParameter>time</pivotParameter>
      </options>
    </HistorySet>
  </DataObjects>

  <OutStreams>
    <Print name="samplesHS">
      <type>csv</type>
      <source>samplesHS</source>
      <what>input,output</what>
    </Print>
  </OutStreams>

</Simulation>
