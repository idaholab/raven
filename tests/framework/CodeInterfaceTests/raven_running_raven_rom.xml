<?xml version="1.0" ?>
<Simulation verbosity="debug">
  <TestInfo>
    <name>framework/CodeInterfaceTests.RAVENrunningRAVEN_ROM</name>
    <author>talbpaul</author>
    <created>2018-01-25</created>
    <classesTested>Models.Code.RAVEN</classesTested>
    <description>
       Tests the raven-runs-raven mechanics.
       INNER samples the "projectile" external model three times, with variable "v0" and constants "ang","y0" and produce a ROM from the results.
       OUTER (this file) will perturb the ROM parameters "loss factor", "tolerance", and constant "ang" in the INNER input file.
       This tests the MPI implementation of the slave runs (batchSize 3, NumMPI 2).  Note that OUTER.NumMPI must be equal to INNER.batchSize.
    </description>
  </TestInfo>
  <!-- RUNINFO -->
  <RunInfo>
    <WorkingDir>Raven_running_raven_rom</WorkingDir>
    <Sequence>sample</Sequence>
    <!-- Is this next comment true? - talbpaul -->
    <!-- This settings here are going to run 3 SLAVE RAVENs at a time, each of them using 2 processors -->
    <batchSize>1</batchSize>
    <NumMPI>3</NumMPI>
    <mode>mpi</mode>
  </RunInfo>

  <Files>
    <Input name="innerInput" type="raven" >inner.xml</Input>
  </Files>

  <!-- STEPS -->
  <Steps>
    <MultiRun name="sample" re-seeding="1">
      <Input class="Files" type="raven">innerInput</Input>
      <Model class="Models" type="Code">raven</Model>
      <Sampler class="Samplers" type="Grid">grid</Sampler>
      <Output class="DataObjects" type="PointSet">outerPS</Output>
      <Output class="DataObjects" type="HistorySet">outerHS</Output>
      <Output class="OutStreams" type="Print">outerPS</Output>
      <Output class="OutStreams" type="Print">outerHS</Output>
    </MultiRun>
  </Steps>

  <!-- MODELS -->
  <Models>
    <Code name="raven" subType="RAVEN">
        <executable>%FRAMEWORK_DIR%/../raven_framework</executable>
        <outputExportOutStreams>returnPS,returnHS</outputExportOutStreams>
        <conversionModule>raven_running_raven_internal_models/testConversionModule.py</conversionModule>
        <alias variable="loss_factor" type="input">Models|ROM@subType:SciKitLearn@name:ROM1|C</alias>
        <alias variable="tolerance"  type="input">Models|ROM@subType:SciKitLearn@name:ROM1|tol</alias>
        <alias variable="ang"  type="input">Samplers|Grid@name:grid|constant@name:ang</alias>
    </Code>
  </Models>

  <!-- DISTRIBUTIONS -->
  <Distributions>
    <Normal name="C_distrib">
      <mean>4</mean>
      <sigma>0.1</sigma>
    </Normal>
    <Normal name="tol_distrib">
      <mean>0.0001</mean>
      <sigma>0.000001</sigma>
    </Normal>
    <Uniform name="ang_distrib">
      <lowerBound>15</lowerBound>
      <upperBound>75</upperBound>
    </Uniform>
  </Distributions>

  <!-- SAMPLERS -->
  <Samplers>
    <Grid name="grid">
      <variable name="loss_factor">
        <distribution>C_distrib</distribution>
        <grid type="CDF" construction="equal" steps="1">0.1 0.9</grid>
      </variable>
      <variable name="tolerance">
        <distribution>tol_distrib</distribution>
        <grid type="CDF" construction="equal" steps="1">0.1 0.9</grid>
      </variable>
      <variable name="ang">
        <distribution>ang_distrib</distribution>
        <grid type="CDF" construction="equal" steps="1">0 1</grid>
      </variable>
    </Grid>
  </Samplers>

  <!-- OUTSTREAMS -->
  <OutStreams>
    <Print name="outerHS">
      <type>csv</type>
      <source>outerHS</source>
      <what>input,output</what>
    </Print>
    <Print name="outerPS">
      <type>csv</type>
      <source>outerPS</source>
      <what>input,output</what>
    </Print>
  </OutStreams>

  <!-- DATA OBJECTS -->
  <DataObjects>
    <PointSet name="inputPlaceHolder">
      <Input>loss_factor,tolerance,ang</Input>
      <Output>OutputPlaceHolder</Output>
    </PointSet>
    <PointSet name="outerPS">
      <Input>loss_factor,tolerance,ang,y0,v0</Input>
      <Output>r</Output>
    </PointSet>
    <HistorySet name="outerHS">
      <Input>loss_factor,tolerance,ang,y0,v0</Input>
      <Output>r</Output>
      <options>
        <pivotParameter>time</pivotParameter>
      </options>
    </HistorySet>
  </DataObjects>

</Simulation>
